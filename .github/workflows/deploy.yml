name: CI/CD - Sensor API (Deploy via SSH + Deploy Key GitHub)

on:
  push:
    branches:
      - main  # dispara o deploy quando houver push na main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout do reposit√≥rio (necess√°rio apenas para vari√°veis)
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Deploy remoto via SSH
      - name: Deploy remoto no servidor Debian
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            echo "üì¶ Iniciando deploy no servidor remoto..."

            PROJECT_PATH="/srv/sensor-api"
            REPO_SSH="git@github.com:Monitoramento-Ambiental/sensor-api.git"

            # Cria o diret√≥rio se n√£o existir
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "üìÅ Criando diret√≥rio do projeto em $PROJECT_PATH ..."
              sudo mkdir -p $PROJECT_PATH
              sudo chown -R $USER:$USER $PROJECT_PATH
              sudo chmod 755 $PROJECT_PATH
            fi

            cd $PROJECT_PATH

            # Verifica se √© um reposit√≥rio git v√°lido
            if [ ! -d ".git" ]; then
              echo "üöÄ Reposit√≥rio n√£o encontrado. Clonando via SSH (Deploy Key)..."
              rm -rf $PROJECT_PATH/*
              git clone $REPO_SSH $PROJECT_PATH
              cd $PROJECT_PATH
            fi

            echo "üîÑ Atualizando reposit√≥rio..."
            git fetch --all
            git reset --hard origin/main

            echo "‚öôÔ∏è Atualizando arquivo .env..."
            cat <<EOF > .env
            MONGO_URI=${{ secrets.MONGO_URI }}
            DATABASE=${{ secrets.DATABASE }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            EOF
  
            echo "üê≥ Subindo containers..."
            set +e
            docker compose down
            docker compose up -d --build
            STATUS=$?
            set -e
            
            if [ $STATUS -ne 0 ]; then
            echo "‚ùå Erro ao subir containers. Tentando rollback..."
            git reset --hard HEAD~1 || true
            docker compose down
            docker compose up -d --build || true
            echo "‚ö†Ô∏è Rollback executado para vers√£o anterior."
            else
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            fi
