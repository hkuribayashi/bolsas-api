---
name: CI/CD - Sensor API (Deploy via SSH + Deploy Key GitHub)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Deploy remoto no servidor Debian
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            echo "Iniciando deploy no servidor remoto..."

            PROJECT_PATH="/srv/sensor-api"
            REPO_SSH="git@github.com:Monitoramento-Ambiental/sensor-api.git"

            # Cria o diretório se não existir
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "Criando diretório do projeto em $PROJECT_PATH ..."
              sudo mkdir -p $PROJECT_PATH
              sudo chown -R $USER:$USER $PROJECT_PATH
              sudo chmod 755 $PROJECT_PATH
            fi

            cd $PROJECT_PATH

            # Verifica se é um repositório git válido
            if [ ! -d ".git" ]; then
              echo "Repositório não encontrado. Clonando via SSH (Deploy Key)..."
              rm -rf $PROJECT_PATH/*
              git clone $REPO_SSH $PROJECT_PATH
              cd $PROJECT_PATH
            fi

            echo "Atualizando repositório..."
            git fetch --all
            git reset --hard origin/main

            echo "Atualizando arquivo .env..."
            cat <<EOF > .env
            MONGO_URI=${{ secrets.MONGO_URI }}
            DATABASE=${{ secrets.DATABASE }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            EOF
            
            echo "Subindo containers..."
            set +e
            docker compose down
            docker compose up -d --build
            STATUS=$?
            set -e
            
            if [ $STATUS -ne 0 ]; then
            echo "Erro ao subir containers. Tentando rollback..."
            git reset --hard HEAD~1 || true
            docker compose down
            docker compose up -d --build || true
            echo "Rollback executado para versão anterior."
            else
            echo "Deploy concluído com sucesso."
            fi